#' Plot ROC and Precision-Recall curves for a single model with multiple datasets
#'
#' The \code{autoplot} function plots ROC and Precion-Recall curves.
#'
#' @param object \code{smcurves} object generated by
#'   \code{\link{evalmod_m}}.
#'
#' @param curvetype a character vector with the following curve types
#'   \describe{
#'     \item{"ROC"}{ROC curve}
#'     \item{"PRC"}{Precision-Recall curve}
#'     \item{c("ROC", "PRC")}{ROC and Precision-Recall curves}
#'   }
#'
#' @param ret_grob A boolean value to indicate whether
#'   \code{autoplot} returns a frame grob object.
#'
#' @param ... Not used by this method.
#'
#' @return The \code{autoplot} function returns a \code{ggplot} object
#'   for a single plot and a frame grob object for multiple plots.
#'
#' @seealso \code{\link{evalmod_m}} for generating \code{smcurves}.
#'
#' @seealso \code{\link{evalmod_m}} for generating \code{smcurves}.
#'  \code{\link{fortify.smcurves}} for converting \code{smcurves} to list.
#'  \code{\link{plot.smcurves}} for plotting the same curves
#'   with the general R plot.
#'
#' @examples
#'
#' ## Load libraries
#' library(ggplot2)
#' library(grid)
#' library(gridExtra)
#'
#' ## Prepare input data
#' samps <- create_sim_samples(10, 100, 100, "poor_er")
#' mdat <- mmdata(samps[["scores"]], samps[["labels"]],
#'                modnames = samps[["modnames"]],
#'                dsids = samps[["dsids"]])
#'
#' ## Generate an mscurve object
#' curves <- evalmod_m(mdat)
#'
#' ## Plot both ROC and Precision-Recall curves
#' autoplot(curves)
#'
#' ## Plot a ROC curve
#' autoplot(curves, curvetype = "ROC")
#'
#' ## Plot a Precision-Recall curve
#' pp1 <- autoplot(curves, curvetype = "PRC")
#' pp1
#'
#' ## autoplot returns a grob object.
#' pp2 <- autoplot(curves, ret_grob = TRUE)
#' plot.new()
#' grid.draw(pp2)
#'
#' @export
autoplot.smcurves <- function(object, curvetype = c("ROC", "PRC"),
                              show_ci = TRUE, all_curves = FALSE,
                              ret_grob = FALSE, ...) {

  # === Check package availability  ===
  .load_ggplot2()
  .validate(object)
  .check_curvetype(curvetype)
  .check_ret_grob(ret_grob)

  # === Create a ggplot object for ROC&PRC, ROC, or PRC ===
  df <- ggplot2::fortify(object, all_curves = all_curves, ...)

  if ("ROC" %in% curvetype) {
    p_roc <- ggplot2::autoplot(object[["rocs"]], "ROC",
                               subset(df, curvetype == "ROC"),
                               show_ci, all_curves, ...)
  }

  if ("PRC" %in% curvetype) {
    p_prc <- ggplot2::autoplot(object[["prcs"]], "PRC",
                               subset(df, curvetype == "PRC"),
                               show_ci, all_curves, ...)
  }

  if ("ROC" %in% curvetype && "PRC" %in% curvetype) {
    .combine_roc_prc(p_roc, p_prc, show_legend = FALSE, ret_grob = ret_grob)
  } else if ("PRC" %in% curvetype) {
    p_prc
  } else if ("ROC" %in% curvetype) {
    p_roc
  }
}

#
# Plot ROC curves for a single model with multiple datasets
#
autoplot.smroc <- function(object, curvetype = "ROC", df = NULL,
                           show_ci = TRUE, all_curves = FALSE,
                           call_geom_basic = TRUE, ...) {

  df <- .prepare_autoplot(object, curvetype = curvetype, df = df,
                          all_curves = all_curves, ...)

  # === Create a ggplot object ===

  if (all_curves) {
    p <- ggplot2::ggplot(df, ggplot2::aes(x = x, y = y, group = dsid))
    p <- p + ggplot2::geom_line()

  } else if (show_ci) {
    p <- ggplot2::ggplot(df, ggplot2::aes(x = x, y = y,
                                          ymin = ymin, ymax = ymax))
    p <- p + ggplot2::geom_smooth(stat = "identity")
  } else {
    p <- ggplot2::ggplot(df, ggplot2::aes(x = x, y = y))
    p <- p + ggplot2::geom_line()
  }

  if (call_geom_basic) {
    p <- .geom_basic_roc(p, object[[1]], show_legend = FALSE)
  }

  p
}

#
# Plot Precision-Recall curves for a single model with multiple datasets
#
autoplot.smprc <- function(object, curvetype = "PRC", df = NULL,
                           show_ci = TRUE, all_curves = FALSE, ...) {

  p <- autoplot.smroc(object, curvetype = curvetype, df = df,
                      show_ci = show_ci, all_curves = all_curves,
                      call_geom_basic = FALSE, ...)

  p <- .geom_basic_prc(p, object[[1]], show_legend = FALSE)
}
